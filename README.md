# CLAS12 simulations
Simple package set to obtain simulations in JLAB's farm (Based in E. Molina code).
The whole workflow consist in three major parts:
1. Event Generation with LEPTO
2. Particle passage through CLAS12 detector with GEMC.
3. Event reconstruction.

## Thrown (LEPTO)
### Setting Environment for compilation
- In JLab machines, set the environmet by loading clas12 modules:
  - module use /scigroup/cvmfs/hallb/clas12/sw/modulefiles
  - module load clas12
- Then, to compile LEPTO set the rest of the environment by running:
  - source thrown/set_env.sh

### List of scripts:
- **lepto2dat** : perl code modified from W. Brooks' original code. It transforms the output of lepto to a .dat file that can be easily read by *dat2tuple*.
    - *usage* : perl lepto2dat.pl z_vertex < lepto_original.out > lepto_out.dat
- **dat2tuple** : C++ code that takes a file formated by *lepto2dat* and outputs a root file with tuples for the electrons, hadrons, and raw.
    - *usage* :
       1. Execute *make*
       2. In bin folder: *./dat2tuple <input_file_name> <output_file_name>*
- **dat2root** : root macro to convert .dat output to raw root file.
    - *usage* : root dat2root
- **lepto** : Particle generator. check its own README in Lepto64 subdirectory.

### Notes
- To modify beam energy, it has to changed in:
  - clas12-rge-simul/thrown/dat2tuple/include/constants.h
  - clas12-rge-simul/thrown/Lepto64/src_f/qp1.f

## CLAS12 Simulation (GEMC)
In reconstruction directory there are three bash scripts to runs simualtions:
- **send_jobs** : This script checks if all neccesary directories and executables needed for the simulation exist and creates the output sudirectories for the simulations. It also defines all parameters neccesary for sending the jobs like directory names, target, number of jobs, number of events per job, torus and solenoid strenght. It send jobs to the farm with the run_full_simulation script to process. Modify this script with the parameters needed.
- **run_full_simulation** : This script takes the parameters defined in send_jobs and runs all the steps neccesary to create thi simulation files. First it creates a temporary directory to work in for each job. Then it runs lepto, then GEMC and finally the recosntruction. At the ends it copies all the requested output file into the output directories defined in send_jobs and deletes the temporary directory.
- **clean_logs** : delete all .out and .err from out and err subdirectories.

## Reconstruction
It runs the reconstruction of the data with hipo format generated by GEMC by running:
recon-util -y clas12.yaml -i ${gemc_out}.hipo -o ${gemc_out}.rec.hipo
It gives an output file in .hipo format taht can be read directly or transformed into root for further process.

## Quick notes!
- The workflow is thought to be run with GEMC 5, it can be modified to run with GEMC, by changing the output format of GEMC from .hipo to .ev and add a conversion from EVIO to HIPO in order to feed the recosntruction software with an hipo file. For this change the GEMC output by commenting and uncommenting the corresponding lines in run_full_reconstruction in THE GEMC block and uncomment the HIPO to EVIO transformation in the Recosntruction block.

## TODO
- Add a short description of every piece code used in run_full_simulation.sh and usage
- Once the target model is incorporated officialy to GEMC, remove the use of the target included here in run_full_simulation.sh and modify the gcard to use the official one. Keep the models just in case of future testing.
- Test